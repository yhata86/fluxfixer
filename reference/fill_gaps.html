<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Fill missing values with a random forest model — fill_gaps • fluxfixer</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fill missing values with a random forest model — fill_gaps"><meta name="description" content="`fill_gaps()` replaces all missing values in a target time
 series with values estimated by a random forest model whose hyperparameters
 are calibrated using a grid search approach and out-of-bag evaluation."><meta property="og:description" content="`fill_gaps()` replaces all missing values in a target time
 series with values estimated by a random forest model whose hyperparameters
 are calibrated using a grid search approach and out-of-bag evaluation."><meta property="og:image" content="https://yhata86.github.io/fluxfixer/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fluxfixer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/fluxfixer.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/yhata86/fluxfixer/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Fill missing values with a random forest model</h1>
      <small class="dont-index">Source: <a href="https://github.com/yhata86/fluxfixer/blob/main/R/construct_randomforest.R" class="external-link"><code>R/construct_randomforest.R</code></a></small>
      <div class="d-none name"><code>fill_gaps.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>`fill_gaps()` replaces all missing values in a target time
 series with values estimated by a random forest model whose hyperparameters
 are calibrated using a grid search approach and out-of-bag evaluation.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">fill_gaps</span><span class="op">(</span></span>
<span>  <span class="va">df</span>,</span>
<span>  <span class="va">colname_label</span>,</span>
<span>  vctr_colname_feature <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  vctr_min_nodesize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>  vctr_m_try <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  vctr_subsample_gf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>  frac_train <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>  n_tree <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  ran_seed <span class="op">=</span> <span class="fl">12345</span>,</span>
<span>  label_err <span class="op">=</span> <span class="op">-</span><span class="fl">9999</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-df">df<a class="anchor" aria-label="anchor" href="#arg-df"></a></dt>
<dd><p>A data frame including label (explained variable) and feature
(explanatory variables) time series for model input. It is acceptable to
include missing values in each column.</p></dd>


<dt id="arg-colname-label">colname_label<a class="anchor" aria-label="anchor" href="#arg-colname-label"></a></dt>
<dd><p>A character representing the name of the column for the
label time series.</p></dd>


<dt id="arg-vctr-colname-feature">vctr_colname_feature<a class="anchor" aria-label="anchor" href="#arg-vctr-colname-feature"></a></dt>
<dd><p>A vector of characters indicating the name of
the feature time series columns used in constructing a random forest model.
If `NULL` (default), all columns excluding the label column specified as
`colname_label` in the input data frame are used as feature columns.</p></dd>


<dt id="arg-vctr-min-nodesize">vctr_min_nodesize<a class="anchor" aria-label="anchor" href="#arg-vctr-min-nodesize"></a></dt>
<dd><p>A vector of positive integers indicating candidates
of a hyperparameter for the random forest model, defining the minimal node
size (the minimum number of data points included in each leaf node).
Default is `c(5)`.</p></dd>


<dt id="arg-vctr-m-try">vctr_m_try<a class="anchor" aria-label="anchor" href="#arg-vctr-m-try"></a></dt>
<dd><p>A vector of positive integers indicating candidates of a
hyperparameter for the random forest model, defining the number of features
to be used in splitting each node. If `NULL` (default), integers between
two and the number of all feature variables are tested.</p></dd>


<dt id="arg-vctr-subsample-gf">vctr_subsample_gf<a class="anchor" aria-label="anchor" href="#arg-vctr-subsample-gf"></a></dt>
<dd><p>A vector of numerical values between 0 and 1,
indicating candidates of a hyperparameter for the random forest model,
defining the fraction of input training data points to be sampled in
constructing the random forest. Default is `c(1)`.</p></dd>


<dt id="arg-frac-train">frac_train<a class="anchor" aria-label="anchor" href="#arg-frac-train"></a></dt>
<dd><p>A numerical value between 0 and 1, defining the fraction
of data points to be categorized as training data for the random forest
model construction. The other data points are classified as test data.
Default is 0.75.</p></dd>


<dt id="arg-n-tree">n_tree<a class="anchor" aria-label="anchor" href="#arg-n-tree"></a></dt>
<dd><p>An integer representing the number of trees in the random
forest. Default is 500.</p></dd>


<dt id="arg-ran-seed">ran_seed<a class="anchor" aria-label="anchor" href="#arg-ran-seed"></a></dt>
<dd><p>An integer representing the random seed for the random
forest model construction. Default is 12345.</p></dd>


<dt id="arg-label-err">label_err<a class="anchor" aria-label="anchor" href="#arg-label-err"></a></dt>
<dd><p>A numeric value representing a missing value in the input
vector(s). Default is -9999.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A list with two elements. The first element `mse` is the mean squared error
between predicted and original values in the test data set. The second
element `stats` is a data frame with columns below:</p>
<p>* The first column, `gapfilled`, gives the gap-filled time series, where
 missing values are replaced with the predicted values from the random
 forest model.</p>
<p>* The second column, `avg_predicted`, gives the ensemble mean time series
 calculated from estimated values at each time point for each tree in the
 constructed random forest.</p>
<p>* The third column, `sd_predicted`, gives the ensemble mean time series
 calculated from estimated values at each time point for each tree in the
 constructed random forest.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>A random forest model is constructed for the targeted time series to fill
missing values. The time series is assumed to be stationary, so detrending
is needed before inputting if it has a trend. Users can input any feature
from the dataset, and out-of-bag evaluation is used to determine the
hyperparameters. This evaluation is applied to a training dataset separated
from the entire input data. To reduce the computational cost, the only
hyperparameter used by default for grid search is the number of candidate
features. After determining the optimal hyperparameters, they are used to
construct the optimal random forest model. Predicted time series are equal
to the average of 500 (default) tree outputs at each time point. If the
input targeted value is missing, the predicted value is used for the
imputation.</p>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Yoshiaki Hata</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">## Load data</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">dt_noisy</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">df_raw</span> <span class="op">&lt;-</span> <span class="va">dt_noisy</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">13105</span><span class="op">:</span><span class="fl">14112</span><span class="op">)</span>, <span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Remove error values for making data gaps</span></span></span>
<span class="r-in"><span><span class="va">df_raw</span><span class="op">$</span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">df_raw</span><span class="op">$</span><span class="va">dt</span> <span class="op">&gt;</span> <span class="fl">9.5</span>, <span class="va">df_raw</span><span class="op">$</span><span class="va">dt</span>, <span class="op">-</span><span class="fl">9999</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Fill data gaps</span></span></span>
<span class="r-in"><span><span class="va">result</span> <span class="op">&lt;-</span></span></span>
<span class="r-in"><span>  <span class="fu">fill_gaps</span><span class="op">(</span>df <span class="op">=</span> <span class="va">df_raw</span>, colname_label <span class="op">=</span> <span class="st">"dt"</span>,</span></span>
<span class="r-in"><span>            vctr_colname_feature <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sw_in"</span>, <span class="st">"vpd"</span>, <span class="st">"swc"</span>, <span class="st">"ta"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">stats</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Random forest-based gap-filling started</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> --- Hyperparameter optimization using grid search started</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> --- MSE: Mean square error for out-of-bag data</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> --- Hyperparameter set: [m_try, min_nodesize, subsample]</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> --- MSE: 0.0676186047, Hyperparameter set: [2, 5, 1]</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> --- MSE: 0.06559005, Hyperparameter set: [3, 5, 1]</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> --- MSE: 0.0665401028, Hyperparameter set: [4, 5, 1]</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> --- Optimal hyperparameter set: [3, 5, 1]</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> --- Hyperparameter optimization using grid search finished</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> --- Random forest construction started</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> --- Random forest construction finished</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Random forest-based gap-filling finished</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Yoshiaki Hata.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>


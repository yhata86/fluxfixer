<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Remove outliers by Z-score time series — remove_zscore_outlier • fluxfixer</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Remove outliers by Z-score time series — remove_zscore_outlier"><meta name="description" content="`remove_zscore_outlier()` detects and removes outlier values by
 converting an original time series into a Z-score time series using a
 moving window."><meta property="og:description" content="`remove_zscore_outlier()` detects and removes outlier values by
 converting an original time series into a Z-score time series using a
 moving window."><meta property="og:image" content="https://yhata86.github.io/fluxfixer/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fluxfixer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/fluxfixer.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/yhata86/fluxfixer/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Remove outliers by Z-score time series</h1>
      <small class="dont-index">Source: <a href="https://github.com/yhata86/fluxfixer/blob/main/R/remove_statistical_outlier.R" class="external-link"><code>R/remove_statistical_outlier.R</code></a></small>
      <div class="d-none name"><code>remove_zscore_outlier.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>`remove_zscore_outlier()` detects and removes outlier values by
 converting an original time series into a Z-score time series using a
 moving window.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">remove_zscore_outlier</span><span class="op">(</span></span>
<span>  <span class="va">vctr_time</span>,</span>
<span>  <span class="va">vctr_target</span>,</span>
<span>  vctr_time_prd_tail <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  wndw_size_z <span class="op">=</span> <span class="fl">48</span> <span class="op">*</span> <span class="fl">15</span>,</span>
<span>  min_n_wndw_z <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  thres_z <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  n_calc_max <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  modify_z <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  vctr_time_zmod <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  wndw_size_conv <span class="op">=</span> <span class="fl">48</span> <span class="op">*</span> <span class="fl">15</span>,</span>
<span>  inv_sigma_conv <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>  thres_ratio <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  label_err <span class="op">=</span> <span class="op">-</span><span class="fl">9999</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-vctr-time">vctr_time<a class="anchor" aria-label="anchor" href="#arg-vctr-time"></a></dt>
<dd><p>A timestamp vector of class POSIXct or POSIXt.</p></dd>


<dt id="arg-vctr-target">vctr_target<a class="anchor" aria-label="anchor" href="#arg-vctr-target"></a></dt>
<dd><p>A vector of a targeted time series to be checked. The
length of the time series must be the same as that of `vctr_time`.</p></dd>


<dt id="arg-vctr-time-prd-tail">vctr_time_prd_tail<a class="anchor" aria-label="anchor" href="#arg-vctr-time-prd-tail"></a></dt>
<dd><p>A timestamp vector of class POSIXct or POSIXt,
indicating the end timings of each sub-period. Note that users must not
include the final timestamp for the entire time series. For instance, if
users want to split the entire measurement period into three sub-periods,
they only need to specify the end time stamps of the first two sub-periods.
Default is `NULL`.</p></dd>


<dt id="arg-wndw-size-z">wndw_size_z<a class="anchor" aria-label="anchor" href="#arg-wndw-size-z"></a></dt>
<dd><p>A positive integer indicating the number of data points
included in a moving window for the Z-score outlier removal. The default is
48 * 15, meaning that the window size is 15 days if the time interval of
the input timestamp is 30 minutes.</p></dd>


<dt id="arg-min-n-wndw-z">min_n_wndw_z<a class="anchor" aria-label="anchor" href="#arg-min-n-wndw-z"></a></dt>
<dd><p>A positive integer indicating the minimum number of data
points for calculating statistics using a moving window (default is 5)  for
the Z-score outlier removal. If the number of data points is less than this
threshold, the statistics are not calculated in the window.</p></dd>


<dt id="arg-thres-z">thres_z<a class="anchor" aria-label="anchor" href="#arg-thres-z"></a></dt>
<dd><p>A positive threshold value for the Z-score time series to
define outliers. Default is 5.0. The data points with Z-scores (absolute
values) above the threshold are considered outliers and removed.</p></dd>


<dt id="arg-n-calc-max">n_calc_max<a class="anchor" aria-label="anchor" href="#arg-n-calc-max"></a></dt>
<dd><p>A positive integer indicating the maximum number of
Z-score outlier detection iterations. Default is 10.</p></dd>


<dt id="arg-modify-z">modify_z<a class="anchor" aria-label="anchor" href="#arg-modify-z"></a></dt>
<dd><p>A boolean. If `TRUE`, conduct Z-score short attenuation
correction; else, the correction is not applied. Default is `FALSE`.</p></dd>


<dt id="arg-vctr-time-zmod">vctr_time_zmod<a class="anchor" aria-label="anchor" href="#arg-vctr-time-zmod"></a></dt>
<dd><p>Only valid if `modify_z` is `TRUE`. A timestamp vector
of class POSIXct or POSIXt, indicating the timings when the short-term
signal attenuation correction is applied. Default is `NULL`.</p></dd>


<dt id="arg-wndw-size-conv">wndw_size_conv<a class="anchor" aria-label="anchor" href="#arg-wndw-size-conv"></a></dt>
<dd><p>Only valid if `modify_z` is `TRUE`. A positive integer
indicating the number of data points included in a moving window for the
short-term signal attenuation detection. The default is 48 * 15, meaning
that the window size is 15 days if the time interval of the input timestamp
is 30 minutes.</p></dd>


<dt id="arg-inv-sigma-conv">inv_sigma_conv<a class="anchor" aria-label="anchor" href="#arg-inv-sigma-conv"></a></dt>
<dd><p>Only valid if `modify_z` is `TRUE`. A positive value
defining a Gaussian window width for the short-term signal attenuation
detection. The width of the Gaussian window is inversely proportional to
this parameter. Default is 0.01.</p></dd>


<dt id="arg-thres-ratio">thres_ratio<a class="anchor" aria-label="anchor" href="#arg-thres-ratio"></a></dt>
<dd><p>Only valid if `modify_z` is `TRUE`. A positive threshold
value of the ratio for determining whether the signal attenuation
correction is applied to each detected attenuation period. The ratio
represents the average of the standard deviation at the detected
attenuation peak relative to that at the beginning and end of the
attenuation period. If the ratio is below this threshold value, the
correction is applied. Default is 0.5.</p></dd>


<dt id="arg-label-err">label_err<a class="anchor" aria-label="anchor" href="#arg-label-err"></a></dt>
<dd><p>A numeric value representing a missing value in the input
vector(s). Default is -9999.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A data frame with columns below:</p>
<p>* The first column, `time`, gives the same timestamp as `vctr_time`.</p>
<p>* The second column, `cleaned`, gives the cleaned time series after replacing
 the detected outliers with the value specified by `label_err`.</p>
<p>* The third column, `z_cleaned`, gives the Z-score of the input time series
 after removing the detected outliers.</p>
<p>* The fourth column, `avg_cleaned`, gives the moving window average of the
 input time series after removing the detected outliers.</p>
<p>* The fifth column, `sd_cleaned`, gives the moving window standard
 deviation of the input time series after removing the detected outliers.</p>
<p>* The sixth column, `flag_out` gives a flag variable time series indicating
 the status of the cleaned time series (0: the input data point is not
 originally missing and not detected as an outlier; 1: the input data point
 is not originally missing but detected as an outlier; 2: the input data
 point is originally missing).</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The input time series is standardized using a moving window, and the data
values are converted to Z-scores. In this step, the width of the moving
window is set to 15 days by default, centered on the target time point,
and standardization is performed individually for each time point in the
time series. The threshold of the Z-score absolute value (default: 5 as
specified by 'thres_z') is set, and data points outside that range are
removed as outliers. After the outliers have been removed, the Z-score is
returned to the original value using the original mean and standard
deviation time series, and standardization is performed again using a moving
window to remove additional outliers. These procedures are repeated until
either no more outliers are removed or the maximum number of iterations
(default 10) is reached.</p>
<p>Users can define sub-periods across the entire time series using
`vctr_time_prd_tail`, and the Z-score conversion is performed in each
sub-period separately. This separated conversion is useful when the input
time series suddenly changes its nature, such as after a sensor replacement.</p>
<p>In some cases, for sap flow measurements, the input dT (the temperature
difference between sap flow probes) time series may yield a signal that is
attenuated for only a short period, for example, when rainfall continues for
days, causing the moving window mean (or standard deviation) to increase
(or decrease). In such cases, standardization  will cause the Z-score time
series immediately before and after the rainfall to be unnaturally
distorted, hindering the construction of the random forest model. If
`modify_z` is `TRUE`, after the outlier removal, this function modifies the
Z-score time series for periods when the moving window average has an upward
peak, and the moving window standard deviation has a downward peak
simultaneously. First, the average and standard deviation time series are
interpolated if they contain missing values. Second, they are smoothed by
convolution with a user-specified Gaussian window, defined by the parameters
`wndw_size_conv` and `inv_sigma_conv`. Third, the first-order and
second-order differences of both smoothed time series are calculated, which
determine the upward peak positions of the average and the downward peak
positions of the standard deviation. Fourth, possible signal attenuation
periods are determined based on these peak positions. The start and end of
the periods are defined by the timings when the first-order differenced
standard deviation time series changes its sign before and after each peak.
Fifth, the final attenuation periods are selected if the average of the
ratio of the standard deviation at the detected attenuation peak to that at
the beginning and end of the attenuation period is below the threshold value
specified by `thres_ratio`. Optionally, users can specify the periods to be
modified by `vctr_time_zmod`. Sixth, the average and standard deviation time
series during the attenuation periods are deleted and linearly interpolated.
Finally, the modified Z-score time series is calculated using these average
and standard deviation time series.</p>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Yoshiaki Hata</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">## Load data</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">dt_noisy</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">time</span> <span class="op">&lt;-</span> <span class="va">dt_noisy</span><span class="op">$</span><span class="va">time</span><span class="op">[</span><span class="fl">12097</span><span class="op">:</span><span class="fl">14400</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">target</span> <span class="op">&lt;-</span> <span class="va">dt_noisy</span><span class="op">$</span><span class="va">dt</span><span class="op">[</span><span class="fl">12097</span><span class="op">:</span><span class="fl">14400</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Remove outliers</span></span></span>
<span class="r-in"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">remove_zscore_outlier</span><span class="op">(</span>vctr_time <span class="op">=</span> <span class="va">time</span>, vctr_target <span class="op">=</span> <span class="va">target</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Z-score outlier detection started</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> --- 8 Z-score outliers were detected</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> --- 1 Z-score outlier was detected</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> --- No Z-score outlier was detected</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Z-score outlier detection finished</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Yoshiaki Hata.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>


# fluxfixer

## Overview

The goal of fluxfixer is to automatically post-process sap flow data
measured by the thermal dissipation method.

Notably, this package can detect outliers and fill data gaps using a
machine learning method that takes environmental variables as input.
These quality control protocols can also be applied to other types of
raw time series with many artifacts.

fluxfixer provides various functions that can detect aberrant structural
changes in time series dynamics, correct such time series, and calculate
sap flux density with different methods for deriving zero-flow
conditions.

Basically, you can conduct the whole process by executing only one
function,
[`run_fluxfixer()`](https://yhata86.github.io/fluxfixer/reference/run_fluxfixer.md).
Optionally, you can apply each process step-by-step using the functions
such as:

- [`check_absolute_limits()`](https://yhata86.github.io/fluxfixer/reference/check_absolute_limits.md)
  eliminates physically unreasonable values.
- [`modify_short_drift()`](https://yhata86.github.io/fluxfixer/reference/modify_short_drift.md)
  corrects short-term signal drifts.
- [`filter_highfreq_noise()`](https://yhata86.github.io/fluxfixer/reference/filter_highfreq_noise.md)
  filters high-frequency noise from the time series.
- [`remove_zscore_outlier()`](https://yhata86.github.io/fluxfixer/reference/remove_zscore_outlier.md)
  detects and removes outliers by Z-score transformation.
- [`remove_rf_outlier()`](https://yhata86.github.io/fluxfixer/reference/remove_rf_outlier.md)
  detects and removes outliers by a random forest model.
- [`fill_gaps()`](https://yhata86.github.io/fluxfixer/reference/fill_gaps.md)
  imputes all missing values in the time series by a random forest
  model.
- [`retrieve_ts()`](https://yhata86.github.io/fluxfixer/reference/retrieve_ts.md)
  converts a standardized Z-score time series into a time series in its
  original units while conducting detrending and signal damping
  correction.

For sap flow data processing:

- [`calc_dtmax()`](https://yhata86.github.io/fluxfixer/reference/calc_dtmax.md)
  estimates the reference values of observed temperature difference
  between probes under zero-flow conditions (dTmax) with multiple
  methods.
- [`calc_fd()`](https://yhata86.github.io/fluxfixer/reference/calc_fd.md)
  calculates sap flux density, considering the heartwood correction.

You can learn more about how to use them in
`browseVignettes("fluxfixer")`.

## Installation

You can install the latest version of fluxfixer from
[CRAN](https://cran.r-project.org/) with:

``` r
install.packages("fluxfixer")
```

Or, you can install the development version from
[GitHub](https://github.com/) with:

``` r
# install.packages("remotes")
remotes::install_github("yhata86/fluxfixer")
```

## Example

Assume that you have conducted a sap flow measurement in Malaysia from
Sep. 2012 to Aug. 2013, and obtained a half-hourly time series below:

![](reference/figures/README-example_raw-1.png)

where $\Delta T$ is the temperature difference between sap flow probes,
which will be used in calculating the sap flux density ($F_{d}$).

You may feel upset since the time series has:

- many values near zero due to power supply shortages
- short-term drift in May, just after sensor replacement
- Long-term trend of the daily maximum value because of sensor
  degradation

Do not worry. fluxfixer can rescue this time series and output a
continuous, stationary time series.

To begin with, you prepare a dataset containing raw $\Delta T$ and other
environmental variables, and specify the timestamps of the events.

``` r
## Load sample data
data("dt_noisy")

## Specify the period of the short-term drift
time_drft_head <- as.POSIXct("2013/05/14 13:30", tz = "Etc/GMT-8")
time_drft_tail <- as.POSIXct("2013/05/17 15:00", tz = "Etc/GMT-8")

## Specify the sensor replacement timing
time_prd_tail <- as.POSIXct("2013/05/14 13:00", tz = "Etc/GMT-8")
```

Then, the only thing you need is to execute
[`run_fluxfixer()`](https://yhata86.github.io/fluxfixer/reference/run_fluxfixer.md)
as:

``` r
## Run all processes automatically
result <-
  run_fluxfixer(df = dt_noisy,
                colname_time = "time",
                colname_target = "dt",
                vctr_time_drft_head = time_drft_head,
                vctr_time_drft_tail = time_drft_tail,
                vctr_time_prd_tail = time_prd_tail,
                detrend = TRUE)
```

You can derive a data frame containing the post-processed time series
below.

![](reference/figures/README-example_gf-1.png)

The output data frame also contains $F_{d}$ time series, which you
ultimately want. Here is an example of the post-processed half-hourly
$F_{d}$ time series in Feb. 2013.

![](reference/figures/README-example_fd-1.png)

The shaded area represents the gap-filled period by the random forest
model. You can see that the imputed time series reproduced the diurnal
cycle of the non-imputed time series successfully.

## License

This package is open-source and released under the MIT License. See the
LICENSE file for more details.

# Package index

## All functions

- [`calc_dtmax()`](https://yhata86.github.io/fluxfixer/reference/calc_dtmax.md)
  : Calculate dTmax by various methods
- [`calc_dtmax_dr()`](https://yhata86.github.io/fluxfixer/reference/calc_dtmax_dr.md)
  : Calculate dTmax by the double regression method
- [`calc_dtmax_ed()`](https://yhata86.github.io/fluxfixer/reference/calc_dtmax_ed.md)
  : Calculate dTmax by the environmental dependent method
- [`calc_dtmax_mw()`](https://yhata86.github.io/fluxfixer/reference/calc_dtmax_mw.md)
  : Calculate dTmax by the moving window method
- [`calc_dtmax_mw_dr()`](https://yhata86.github.io/fluxfixer/reference/calc_dtmax_mw_dr.md)
  : Calculate dTmax by the moving window and double regression methods
- [`calc_dtmax_pd()`](https://yhata86.github.io/fluxfixer/reference/calc_dtmax_pd.md)
  : Calculate dTmax by the daily predawn method
- [`calc_dtmax_pd_ed()`](https://yhata86.github.io/fluxfixer/reference/calc_dtmax_pd_ed.md)
  : Calculate dTmax by the daily predawn and environmental dependent
  methods
- [`calc_dtmax_sp()`](https://yhata86.github.io/fluxfixer/reference/calc_dtmax_sp.md)
  : Calculate dTmax by the successive predawn method
- [`calc_fd()`](https://yhata86.github.io/fluxfixer/reference/calc_fd.md)
  : Calculate sap flux density time series
- [`calc_ref_stats()`](https://yhata86.github.io/fluxfixer/reference/calc_ref_stats.md)
  : Define reference values of average and standard deviation
- [`calc_sw_in_toa()`](https://yhata86.github.io/fluxfixer/reference/calc_sw_in_toa.md)
  : Calculate global solar radiation time series at TOA
- [`check_absolute_limits()`](https://yhata86.github.io/fluxfixer/reference/check_absolute_limits.md)
  : Remove outliers by absolute limits
- [`check_short_attenuation()`](https://yhata86.github.io/fluxfixer/reference/check_short_attenuation.md)
  : Detect periods when short-term signal attenuation occurs
- [`dt_gf`](https://yhata86.github.io/fluxfixer/reference/dt_gf.md) :
  Quality-controlled and gap-filled dT time series
- [`dt_noisy`](https://yhata86.github.io/fluxfixer/reference/dt_noisy.md)
  : Raw dT time series with various artifacts
- [`dtmax`](https://yhata86.github.io/fluxfixer/reference/dtmax.md) :
  dTmax time series estimated by multiple methods
- [`fill_gaps()`](https://yhata86.github.io/fluxfixer/reference/fill_gaps.md)
  : Fill missing values with a random forest model
- [`filter_highfreq_noise()`](https://yhata86.github.io/fluxfixer/reference/filter_highfreq_noise.md)
  : Filter high frequency noise by Gaussian filter
- [`get_interval()`](https://yhata86.github.io/fluxfixer/reference/get_interval.md)
  : Obtain time interval of input timestamp vector
- [`modify_short_drift()`](https://yhata86.github.io/fluxfixer/reference/modify_short_drift.md)
  : Modify short-term drifts
- [`n_valid()`](https://yhata86.github.io/fluxfixer/reference/n_valid.md)
  : Obtain the number of data points without missing values
- [`remove_manually()`](https://yhata86.github.io/fluxfixer/reference/remove_manually.md)
  : Remove error values manually
- [`remove_rf_outlier()`](https://yhata86.github.io/fluxfixer/reference/remove_rf_outlier.md)
  : Remove outliers detected by a random forest model
- [`remove_zscore_outlier()`](https://yhata86.github.io/fluxfixer/reference/remove_zscore_outlier.md)
  : Remove outliers by Z-score time series
- [`retrieve_ts()`](https://yhata86.github.io/fluxfixer/reference/retrieve_ts.md)
  : Retrieve time series in its original units
- [`rf_fit()`](https://yhata86.github.io/fluxfixer/reference/rf_fit.md)
  : Tune hyperparameters used in a random forest model
- [`rf_pred()`](https://yhata86.github.io/fluxfixer/reference/rf_pred.md)
  : Predict targeted time series by a random forest model
- [`run_fluxfixer()`](https://yhata86.github.io/fluxfixer/reference/run_fluxfixer.md)
  : Run all quality control processes automatically

# Articles

### All vignettes

- [fluxfixer](https://yhata86.github.io/fluxfixer/articles/fluxfixer.md):
